# Shell
if-shell 'test -x /usr/local/bin/zsh' 'set -g default-shell /usr/local/bin/zsh' 'set -g default-shell /usr/bin/zsh'

# Keep Wayland clipboard vars available inside tmux panes.
set -ga update-environment WAYLAND_DISPLAY
set -ga update-environment XDG_RUNTIME_DIR
set -ga update-environment DBUS_SESSION_BUS_ADDRESS

# General
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",*:RGB"
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -g escape-time 0
set -g display-time 4000
set -g focus-events on
set -g set-clipboard on
set -g allow-passthrough on
setw -g aggressive-resize on
set -g detach-on-destroy off

# Reload config
bind q source-file ~/.tmux.conf

# Vi mode for copy
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel
bind -T copy-mode y send-keys -X copy-selection-and-cancel
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-selection-and-cancel

# Pane controls
bind h split-window -v -c "#{pane_current_path}"
bind v split-window -h -c "#{pane_current_path}"
bind x kill-pane

bind -n C-M-Left select-pane -L
bind -n C-M-Right select-pane -R
bind -n C-M-Up select-pane -U
bind -n C-M-Down select-pane -D

bind -n C-M-S-Left resize-pane -L 5
bind -n C-M-S-Down resize-pane -D 5
bind -n C-M-S-Up resize-pane -U 5
bind -n C-M-S-Right resize-pane -R 5

# Window controls
bind r command-prompt -I "#W" "rename-window -- '%%'"
bind c new-window -c "#{pane_current_path}"
bind k kill-window

# Session controls
bind R command-prompt -I "#S" "rename-session -- '%%'"
bind C new-session -c "#{pane_current_path}"
bind K kill-session
bind P switch-client -p
bind N switch-client -n

# Switch last client
bind l switch-client -l

# Alt bindings (no prefix needed)
bind -n M-t new-window -c "#{pane_current_path}"
unbind -n M-g
bind -n M-x run-shell 'current="$(tmux display-message -p "#S")"; tmux switch-client -n 2>/dev/null; tmux kill-session -t "$current"'
bind -n M-w kill-window
bind -n M-b run-shell "~/dotfiles/bin/tmux-wt-spawn.sh"
bind -n M-d new-window -c "#{pane_current_path}" "~/dotfiles/bin/wt destroy"
bind -n M-j copy-mode
bind -n M-k run-shell "~/dotfiles/bin/tmux-session-switcher.sh"
bind -n M-o run-shell "~/dotfiles/bin/opencode-pick"

# Alt+number window switching
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Alt session cycling
bind -n M-n switch-client -n
bind -n M-p switch-client -p

# Shift arrow window switching
bind -n S-Left previous-window
bind -n S-Right next-window

# Ctrl+Shift arrow window reordering
bind-key -n C-S-Left swap-window -t -1\; select-window -t -1
bind-key -n C-S-Right swap-window -t +1\; select-window -t +1

# sesh session picker
bind-key "T" run-shell "sesh connect \"$(sesh list --icons | fzf-tmux -p 80%,70% --no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' --header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' --bind 'tab:down,btab:up' --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c --icons)' --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' --preview-window 'right:55%' --preview 'sesh preview {}')\""

# Smart pane switching with Neovim awareness (fallback when vim-tmux-navigator plugin unavailable)
bind-key -n C-h if -F "#{@pane-is-vim}" 'send-keys C-h' 'select-pane -L'
bind-key -n C-j if -F "#{@pane-is-vim}" 'send-keys C-j' 'select-pane -D'
bind-key -n C-k if -F "#{@pane-is-vim}" 'send-keys C-k' 'select-pane -U'
bind-key -n C-l if -F "#{@pane-is-vim}" 'send-keys C-l' 'select-pane -R'

# Theme (ANSI color names ‚Äî follows terminal palette for Omarchy theme switching)
set -g status-position top
set -g status-interval 5
set -g status-left-length 30
set -g status-right-length 50
set -g window-status-separator ""
set -g status-style "bg=default,fg=default"
set -g status-left "#[fg=black,bg=blue,bold] #S #[bg=default] "
set -g status-right "#[fg=blue]#{?client_prefix,PREFIX ,}#[fg=brightblack]#h "
set -g window-status-format "#[fg=brightblack] #I:#W "
set -g window-status-current-format "#[fg=blue,bold] #I:#W "
set -g pane-border-style "fg=brightblack"
set -g pane-active-border-style "fg=blue"
set -g message-style "bg=default,fg=blue"
set -g message-command-style "bg=default,fg=blue"
set -g mode-style "bg=blue,fg=black"
setw -g clock-mode-colour blue

# Clipboard paste
bind-key -n C-S-v run-shell -b "~/dotfiles/bin/tmux-paste-clipboard '#{pane_id}'"
bind-key -n S-Insert run-shell -b "~/dotfiles/bin/tmux-paste-clipboard '#{pane_id}'"
bind-key -n MouseDown2Pane select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { run-shell -b "~/dotfiles/bin/tmux-paste-clipboard '#{mouse_pane}'" }

# Plugins (TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @fzf-url-bind 'u'
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @scroll-speed-num-lines-per-scroll 1

run '~/.tmux/plugins/tpm/tpm'
