#!/bin/sh
# Worktree branch switcher with directory and tmux session renaming

usage() {
    echo "Usage: $0 spawn <branch> | $0 destroy | $0 <branch-name> [--from-master|-m] | $0 --fix-session|-f"
    echo ""
    echo "Task-oriented worktree manager: spawn worktrees per task, destroy when done."
    echo ""
    echo "Task Commands:"
    echo "  spawn <branch>    Create new worktree from origin/master and switch to tmux session"
    echo "                    Worktree name: {repo}-{branch} (e.g., dotfiles-fix-login-bug)"
    echo "                    Session name: {repo}-{branch}"
    echo "  destroy           Delete current worktree and tmux session, return to main repo"
    echo ""
    echo "Branch Commands:"
    echo "  <branch-name>     Switch to/create branch in current worktree and rename tmux session"
    echo ""
    echo "Options:"
    echo "  -m, --from-master Create new branch from master/main instead of current branch"
    echo "  -f, --fix-session Fix current session name to match expected format"
    echo "  -h, --help        Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 spawn fix-login-bug   # Create worktree dotfiles-fix-login-bug, switch to tmux"
    echo "  $0 destroy               # Delete current worktree, return to main repo"
    echo "  $0 feature-new           # Switch to feature-new in current worktree"
    echo "  $0 feature-new -m        # Create from master/main instead of current branch"
    echo "  $0 --fix-session         # Fix current session name"
}

spawn_impl() {
    BRANCH_NAME="$1"

    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "Error: Not in a git repository"
        exit 1
    fi

    MAIN_REPO_ROOT=$(git rev-parse --show-toplevel)
    if [ -z "$MAIN_REPO_ROOT" ]; then
        echo "Error: Could not determine main repository root"
        exit 1
    fi

    WORKTREE_LIST=$(git worktree list --porcelain 2>/dev/null)
    WORKTREE_COUNT=$(echo "$WORKTREE_LIST" | grep -c "^worktree" || true)
    if [ "$WORKTREE_COUNT" -gt 1 ]; then
        echo "Error: This command must be run from the main repository, not a worktree"
        echo "Current directory: $(pwd)"
        exit 1
    fi

    REPO_NAME=$(basename "$MAIN_REPO_ROOT")
    REPO_PARENT=$(dirname "$MAIN_REPO_ROOT")

    WORKTREE_NAME="${REPO_NAME}-${BRANCH_NAME}"
    WORKTREE_PATH="${REPO_PARENT}/${WORKTREE_NAME}"

    if [ -d "$WORKTREE_PATH" ]; then
        echo "Error: Worktree directory already exists: $WORKTREE_PATH"
        echo "Use 'wt destroy' if you're in that worktree, or choose a different branch name"
        exit 1
    fi

    if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
        echo "Error: Branch '$BRANCH_NAME' already exists locally"
        exit 1
    fi

    echo "Spawning new worktree for task: $BRANCH_NAME"
    echo "  Repository: $REPO_NAME"
    echo "  Worktree: $WORKTREE_PATH"
    echo "  Branch: $BRANCH_NAME (from origin/master)"

    if ! git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH" origin/master; then
        echo "Error: Failed to create worktree"
        exit 1
    fi

    echo "Worktree created successfully"

    if command -v tmux >/dev/null 2>&1; then
        SESSION_NAME="$WORKTREE_NAME"

        if [ -n "$TMUX" ]; then
            if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
                echo "Switching to existing tmux session '$SESSION_NAME'..."
                tmux switch-client -t "$SESSION_NAME"
            else
                echo "Creating new tmux session '$SESSION_NAME'..."
                tmux new-session -d -s "$SESSION_NAME" -c "$WORKTREE_PATH"
                tmux rename-window -t "$SESSION_NAME:1" 'Main'
                tmux switch-client -t "$SESSION_NAME"
            fi
        else
            if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
                echo "Attaching to existing tmux session '$SESSION_NAME'..."
                tmux attach-session -t "$SESSION_NAME"
            else
                echo "Creating new tmux session '$SESSION_NAME'..."
                tmux new-session -d -s "$SESSION_NAME" -c "$WORKTREE_PATH"
                tmux rename-window -t "$SESSION_NAME:1" 'Main'
                tmux attach-session -t "$SESSION_NAME"
            fi
        fi
    else
        echo "Tmux not available, staying in worktree directory..."
        cd "$WORKTREE_PATH" || exit 1
        exec "$SHELL"
    fi
}

destroy_impl() {
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        echo "Error: Not in a git repository"
        exit 1
    fi

    WORKTREE_ROOT=$(git rev-parse --show-toplevel)
    CURRENT_BRANCH=$(git branch --show-current)

    MAIN_REPO_ROOT=$(git worktree list --porcelain | grep -E "^worktree " | head -1 | cut -d' ' -f2)
    if [ -z "$MAIN_REPO_ROOT" ]; then
        echo "Error: Could not determine main repository root"
        exit 1
    fi

    if [ "$WORKTREE_ROOT" = "$MAIN_REPO_ROOT" ]; then
        echo "Error: This command must be run from a spawned worktree, not the main repository"
        echo "Current directory: $(pwd)"
        exit 1
    fi

    REPO_NAME=$(basename "$MAIN_REPO_ROOT")
    WORKTREE_NAME=$(basename "$WORKTREE_ROOT")

    if ! echo "$WORKTREE_NAME" | grep -qE "^${REPO_NAME}-"; then
        echo "Warning: This doesn't look like a spawned worktree (expected: ${REPO_NAME}-*)"
        echo "Current worktree: $WORKTREE_NAME"
        echo "Main repository: $REPO_NAME"
    fi

    echo "Destroying worktree: $WORKTREE_ROOT"
    echo "  Branch: $CURRENT_BRANCH"
    echo "  Worktree name: $WORKTREE_NAME"

    printf "Are you sure you want to delete this worktree? [y/N] "
    read -r response
    case "$response" in
        [yY]|[yY][eE][sS])
            echo "Proceeding with destruction..."
            ;;
        *)
            echo "Aborted."
            exit 0
            ;;
    esac

    if command -v tmux >/dev/null 2>&1; then
        if tmux has-session -t "$WORKTREE_NAME" 2>/dev/null; then
            echo "Killing tmux session '$WORKTREE_NAME'..."
            tmux kill-session -t "$WORKTREE_NAME"
        fi
    fi

    if ! git worktree remove "$WORKTREE_ROOT" --force; then
        echo "Error: Failed to remove worktree"
        exit 1
    fi

    echo "Worktree removed successfully"

    MAIN_SESSION_NAME="${REPO_NAME}"
    if command -v tmux >/dev/null 2>&1; then
        cd "$MAIN_REPO_ROOT" || exit 1

        if [ -n "$TMUX" ]; then
            if tmux has-session -t "$MAIN_SESSION_NAME" 2>/dev/null; then
                echo "Switching to main repository session '$MAIN_SESSION_NAME'..."
                tmux switch-client -t "$MAIN_SESSION_NAME"
            else
                echo "Main repository session doesn't exist, creating..."
                tmux new-session -d -s "$MAIN_SESSION_NAME" -c "$MAIN_REPO_ROOT"
                tmux rename-window -t "$MAIN_SESSION_NAME:1" 'Main'
                tmux switch-client -t "$MAIN_SESSION_NAME"
            fi
        else
            echo "Worktree destroyed. Returning to main repository: $MAIN_REPO_ROOT"
            cd "$MAIN_REPO_ROOT" || exit 1
        fi
    else
        echo "Worktree destroyed. Returning to main repository: $MAIN_REPO_ROOT"
        cd "$MAIN_REPO_ROOT" || exit 1
    fi

    echo "Done!"
}

# Parse arguments
COMMAND=""
BRANCH_NAME=""
FROM_MASTER=false
FIX_SESSION=false

while [ $# -gt 0 ]; do
    case $1 in
        spawn|destroy)
            COMMAND="$1"
            shift
            ;;
        -m|--from-master)
            FROM_MASTER=true
            shift
            ;;
        -f|--fix-session)
            FIX_SESSION=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo "Error: Unknown option $1"
            usage
            exit 1
            ;;
        *)
            if [ -z "$BRANCH_NAME" ]; then
                BRANCH_NAME="$1"
            else
                echo "Error: Too many arguments"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Handle task commands first
if [ "$COMMAND" = "spawn" ]; then
    if [ -z "$BRANCH_NAME" ]; then
        echo "Error: spawn command requires a branch name"
        usage
        exit 1
    fi
    if [ "$FROM_MASTER" = true ]; then
        echo "Error: spawn command always uses origin/master, --from-master not applicable"
        usage
        exit 1
    fi
    if [ "$FIX_SESSION" = true ]; then
        echo "Error: spawn command does not support --fix-session"
        usage
        exit 1
    fi
    spawn_impl "$BRANCH_NAME"
    exit $?
fi

if [ "$COMMAND" = "destroy" ]; then
    destroy_impl
    exit $?
fi

if [ -z "$BRANCH_NAME" ] && [ "$FIX_SESSION" = false ]; then
    echo "Error: Branch name is required"
    usage
    exit 1
fi

# Validate we're in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Get current worktree information
CURRENT_DIR=$(pwd)
WORKTREE_ROOT=$(git rev-parse --show-toplevel)
CURRENT_BRANCH=$(git branch --show-current)

# Check if we're in a worktree by looking at git worktree list
WORKTREE_LIST=$(git worktree list --porcelain 2>/dev/null)
if [ -z "$WORKTREE_LIST" ]; then
    echo "Error: This script is designed for worktrees, but git worktree is not available"
    exit 1
fi

# Find the main repository root from worktree list
MAIN_REPO_ROOT=$(echo "$WORKTREE_LIST" | grep -E "^worktree " | head -1 | cut -d' ' -f2)
if [ -z "$MAIN_REPO_ROOT" ]; then
    echo "Error: Could not determine main repository root"
    exit 1
fi

# Extract repository name and current directory name
REPO_NAME=$(basename "$MAIN_REPO_ROOT")
DIR_NAME=$(basename "$WORKTREE_ROOT")

# Handle fix-session mode
if [ "$FIX_SESSION" = true ]; then
    if ! command -v tmux >/dev/null 2>&1 || [ -z "$TMUX" ]; then
        echo "Error: Not in a tmux session or tmux not available"
        exit 1
    fi
    
    CURRENT_SESSION=$(tmux display-message -p '#S')
    
    # Check if we're in a worktree or main repo
    if [ "$WORKTREE_ROOT" = "$MAIN_REPO_ROOT" ]; then
        # Main repository - just use repo name + branch
        EXPECTED_SESSION_NAME="${REPO_NAME}@${CURRENT_BRANCH}"
    else
        # Worktree - use directory name + branch
        EXPECTED_SESSION_NAME="${DIR_NAME}@${CURRENT_BRANCH}"
    fi
    
    echo "Current session: $CURRENT_SESSION"
    echo "Expected session name: $EXPECTED_SESSION_NAME"
    
    if [ "$CURRENT_SESSION" = "$EXPECTED_SESSION_NAME" ]; then
        echo "Session name already matches expected format"
        exit 0
    fi
    
    # Check if expected session already exists
    if tmux has-session -t "$EXPECTED_SESSION_NAME" 2>/dev/null; then
        echo "Session '$EXPECTED_SESSION_NAME' already exists, switching to it..."
        tmux switch-client -t "$EXPECTED_SESSION_NAME"
    else
        echo "Renaming current session to '$EXPECTED_SESSION_NAME'..."
        if tmux rename-session "$EXPECTED_SESSION_NAME"; then
            echo "Session renamed successfully"
        else
            echo "Error: Failed to rename session"
            exit 1
        fi
    fi
    
    echo "Session fix complete!"
    echo "Session: $(tmux display-message -p '#S')"
    echo "Directory: $(pwd)"
    echo "Branch: $CURRENT_BRANCH"
    exit 0
fi

# Check if we're in a worktree (not the main repo)
if [ "$WORKTREE_ROOT" = "$MAIN_REPO_ROOT" ]; then
    echo "Error: This script is designed for worktrees, not the main repository"
    echo "Current directory appears to be the main repository: $MAIN_REPO_ROOT"
    echo "Use 'wt -f' to fix the session name in the main repository"
    exit 1
fi

echo "Current worktree: $WORKTREE_ROOT"
echo "Current branch: $CURRENT_BRANCH"
echo "Target branch: $BRANCH_NAME"

# Check if target branch already exists
BRANCH_EXISTS=false
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME" || git show-ref --verify --quiet "refs/remotes/origin/$BRANCH_NAME"; then
    BRANCH_EXISTS=true
    echo "Branch '$BRANCH_NAME' exists"
else
    echo "Branch '$BRANCH_NAME' does not exist, will create it"
fi

# Determine base branch for new branch creation
if [ "$BRANCH_EXISTS" = false ]; then
    if [ "$FROM_MASTER" = true ]; then
        # Check if master exists, fallback to main
        if git show-ref --verify --quiet refs/heads/master; then
            BASE_BRANCH="master"
        elif git show-ref --verify --quiet refs/heads/main; then
            BASE_BRANCH="main"
        elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_BRANCH="origin/master"
        elif git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_BRANCH="origin/main"
        else
            echo "Error: Could not find master or main branch"
            exit 1
        fi
        echo "Will create new branch from: $BASE_BRANCH"
    else
        BASE_BRANCH="$CURRENT_BRANCH"
        echo "Will create new branch from current branch: $BASE_BRANCH"
    fi
fi



# Switch or create the branch
if [ "$BRANCH_EXISTS" = true ]; then
    echo "Switching to existing branch '$BRANCH_NAME'..."
    if ! git switch "$BRANCH_NAME"; then
        echo "Error: Failed to switch to branch '$BRANCH_NAME'"
        exit 1
    fi
else
    echo "Creating and switching to new branch '$BRANCH_NAME' from '$BASE_BRANCH'..."
    if ! git switch -c "$BRANCH_NAME" "$BASE_BRANCH"; then
        echo "Error: Failed to create branch '$BRANCH_NAME'"
        exit 1
    fi
fi

echo "Successfully switched to branch '$BRANCH_NAME'"

# Handle tmux session renaming
if command -v tmux >/dev/null 2>&1 && [ -n "$TMUX" ]; then
    CURRENT_SESSION=$(tmux display-message -p '#S')
    NEW_SESSION_NAME="${DIR_NAME}@${BRANCH_NAME}"
    
    echo "Current tmux session: $CURRENT_SESSION"
    echo "New tmux session name: $NEW_SESSION_NAME"
    
    if [ "$CURRENT_SESSION" != "$NEW_SESSION_NAME" ]; then
        # Check if target session name already exists
        if tmux has-session -t "$NEW_SESSION_NAME" 2>/dev/null; then
            echo "Warning: Tmux session '$NEW_SESSION_NAME' already exists"
            echo "Switching to existing session..."
            tmux switch-client -t "$NEW_SESSION_NAME"
        else
            echo "Renaming tmux session to '$NEW_SESSION_NAME'..."
            if tmux rename-session "$NEW_SESSION_NAME"; then
                echo "Tmux session renamed successfully"
            else
                echo "Warning: Failed to rename tmux session"
            fi
        fi
    else
        echo "Tmux session name already matches"
    fi
elif command -v tmux >/dev/null 2>&1; then
    echo "Not in a tmux session, skipping session rename"
else
    echo "Tmux not available, skipping session rename"
fi

echo ""
echo "Branch switch complete!"
echo "Branch: $BRANCH_NAME"
echo "Directory: $(pwd)"
if command -v tmux >/dev/null 2>&1 && [ -n "$TMUX" ]; then
    echo "Tmux session: $(tmux display-message -p '#S')"
fi
