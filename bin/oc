#!/bin/bash
# OpenCode wrapper with random port configuration (40000-50000)
#
# Usage:
#   oc           Start new session
#   oc -c        Continue most recent session for this directory
#   oc [args]    Pass additional args to opencode

# Check for -c/--continue flag and extract other args
CONTINUE_SESSION=false
HAS_PORT=false
ARGS=()

for arg in "$@"; do
    case "$arg" in
        -c|--continue)
            CONTINUE_SESSION=true
            ;;
        --port|-p)
            HAS_PORT=true
            ARGS+=("$arg")
            ;;
        *)
            ARGS+=("$arg")
            ;;
    esac
done

# Add random port if not already specified (40000-50000 range)
if [[ "$HAS_PORT" == false ]]; then
    PORT=$((RANDOM % 10000 + 40000))
    ARGS+=("--port" "$PORT")
fi

if [[ "$CONTINUE_SESSION" == false ]]; then
    exec opencode "${ARGS[@]}"
fi

CURRENT_DIR=$(pwd)

# Get the most recent non-archived session for this directory from SQLite storage
SESSION_ID=""
OPENCODE_DB="${HOME}/.local/share/opencode/opencode.db"

if [[ -f "$OPENCODE_DB" ]]; then
    if command -v sqlite3 >/dev/null 2>&1; then
        ESCAPED_DIR=${CURRENT_DIR//\'/\'\'}
        SESSION_ID=$(sqlite3 -readonly "$OPENCODE_DB" \
            "SELECT id FROM session
             WHERE directory = '$ESCAPED_DIR'
               AND time_archived IS NULL
             ORDER BY time_updated DESC
             LIMIT 1;" 2>/dev/null)
    elif command -v python3 >/dev/null 2>&1; then
        SESSION_ID=$(python3 - "$OPENCODE_DB" "$CURRENT_DIR" 2>/dev/null <<'PY'
import sqlite3
import sys

db_path = sys.argv[1]
directory = sys.argv[2]

conn = sqlite3.connect(db_path)
cur = conn.cursor()
cur.execute(
    """SELECT id
       FROM session
       WHERE directory = ?
         AND time_archived IS NULL
       ORDER BY time_updated DESC
       LIMIT 1""",
    (directory,),
)
row = cur.fetchone()

if row:
    print(row[0])
PY
)
    fi
fi

if [[ -n "$SESSION_ID" ]]; then
    echo "Continuing session: $SESSION_ID"
    exec opencode -s "$SESSION_ID" "${ARGS[@]}"
else
    exec opencode "${ARGS[@]}"
fi
