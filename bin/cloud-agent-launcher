#!/bin/bash
# Cloud Agent Launcher - Launch Cursor background agents
#
# Non-invasive: Does NOT switch local branches. Creates branches directly on remote.
#
# Flow:
# 1. Select existing branch OR type a new branch name to create it (on remote)
# 2. Type the task description
# 3. Launch the cloud agent

# Hardcoded repo path for now
REPO_ROOT="$HOME/dev/work/tweezr"
cd "$REPO_ROOT" || { echo "Failed to cd to $REPO_ROOT"; read -p "Press Enter..."; exit 1; }

REPO_NAME=$(basename "$REPO_ROOT")
CURRENT_BRANCH=$(git branch --show-current)

# Fetch latest remote refs
echo "Fetching latest from remote..."
git fetch origin --quiet

# Step 1: Select or create branch (no local switching)
echo "Repository: $REPO_NAME"
echo "Local branch: $CURRENT_BRANCH (will not change)"
echo ""

# Get remote branches only (what exists on GitHub)
BRANCHES=$(git branch -r --format='%(refname:short)' 2>/dev/null | \
    sed 's|^origin/||' | \
    grep -v '^HEAD$' | \
    sort -u)

# Show branch picker
# Exit code 0 = selected from list, Exit code 1 = no matches (typed new name)
# Ctrl-N forces using typed text (for creating branch when something is highlighted)
RESULT=$(echo "$BRANCHES" | fzf \
    --print-query \
    --no-sort \
    --border-label " Select remote branch in $REPO_NAME " \
    --prompt 'ðŸŒ¿  ' \
    --header 'Enter: select â€¢ Ctrl-N: use typed text â€¢ Type new name to create on remote' \
    --bind 'ctrl-n:become(echo "NEW:{q}")' \
    --preview 'branch="origin/{}"; 
               [[ -n "{}" ]] && git log --oneline -10 "$branch" 2>/dev/null || echo "New branch (will be created from origin/main)"')
FZF_EXIT=$?

# Handle cancelled (Ctrl-C or Escape)
if [[ $FZF_EXIT -eq 130 ]] || [[ -z "$RESULT" ]]; then
    exit 0
fi

# Parse result: line 1 = query, line 2 = selected item
QUERY=$(echo "$RESULT" | head -1)
SELECTED=$(echo "$RESULT" | tail -1)

# Determine the target branch and whether it needs to be created
CREATE_NEW=false
TARGET_BRANCH=""

# Check if Ctrl-N was used (forces typed text)
if [[ "$QUERY" == NEW:* ]] || [[ "$SELECTED" == NEW:* ]]; then
    TARGET_BRANCH="${QUERY#NEW:}"
    [[ "$SELECTED" == NEW:* ]] && TARGET_BRANCH="${SELECTED#NEW:}"
    TARGET_BRANCH=$(echo "$TARGET_BRANCH" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/[[:space:]]/-/g')
    CREATE_NEW=true
elif [[ $FZF_EXIT -eq 0 ]] && [[ -n "$SELECTED" ]]; then
    # Selected from list - use existing remote branch
    TARGET_BRANCH="$SELECTED"
else
    # No matches - create new branch from typed query
    TARGET_BRANCH=$(echo "$QUERY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/[[:space:]]/-/g')
    CREATE_NEW=true
fi

if [[ -z "$TARGET_BRANCH" ]]; then
    echo "Error: No branch name provided" >&2
    read -p "Press Enter to exit..."
    exit 1
fi

# Verify not master/main
if [[ "$TARGET_BRANCH" == "master" || "$TARGET_BRANCH" == "main" ]]; then
    echo ""
    echo "Error: Cannot launch cloud agent on master/main branch." >&2
    echo "Please type a new branch name to create one." >&2
    read -p "Press Enter to exit..."
    exit 1
fi

# Create branch on remote if needed (without local checkout)
if [[ "$CREATE_NEW" == true ]]; then
    # Check if it already exists on remote
    if git show-ref --verify --quiet "refs/remotes/origin/$TARGET_BRANCH"; then
        echo "Branch '$TARGET_BRANCH' already exists on remote"
    else
        # Determine base branch
        if git show-ref --verify --quiet refs/remotes/origin/main; then
            BASE_REF="origin/main"
        elif git show-ref --verify --quiet refs/remotes/origin/master; then
            BASE_REF="origin/master"
        else
            echo "Error: Could not find origin/main or origin/master" >&2
            read -p "Press Enter to exit..."
            exit 1
        fi
        
        echo "Creating branch '$TARGET_BRANCH' on remote from $BASE_REF..."
        # Create branch on remote directly (no local checkout)
        if ! git push origin "$BASE_REF:refs/heads/$TARGET_BRANCH"; then
            echo "Error: Failed to create branch on remote" >&2
            read -p "Press Enter to exit..."
            exit 1
        fi
        echo "Branch created on remote"
    fi
fi

echo ""
echo "Target branch: $TARGET_BRANCH (on remote)"
echo "Local branch: $CURRENT_BRANCH (unchanged)"
echo ""

# Step 2: Get task description using $EDITOR
TASK_FILE=$(mktemp --suffix=.md)
trap "rm -f '$TASK_FILE'" EXIT

cat > "$TASK_FILE" << 'EOF'

# Enter the task for the cloud agent above this line.
# Lines starting with # will be ignored.
# Save and exit to continue, or leave empty to cancel.
EOF

# Open editor (fallback chain: $EDITOR -> vim -> nano)
${EDITOR:-${VISUAL:-vim}} "$TASK_FILE"

# Read task, stripping comments and empty lines
TASK=$(grep -v '^#' "$TASK_FILE" | grep -v '^[[:space:]]*$' | tr '\n' ' ' | sed 's/[[:space:]]*$//')

if [[ -z "$TASK" ]]; then
    echo "Error: No task provided" >&2
    read -p "Press Enter to exit..."
    exit 1
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""
echo "Launching cloud agent..."
echo "  Repository: $REPO_NAME"
echo "  Branch: $TARGET_BRANCH"
echo "  Task: $TASK"
echo ""

# Launch the agent
LAUNCH_SCRIPT="$REPO_ROOT/scripts/launch_cursor_agent.py"

if [[ ! -f "$LAUNCH_SCRIPT" ]]; then
    echo "Error: launch_cursor_agent.py not found at $LAUNCH_SCRIPT" >&2
    read -p "Press Enter to exit..."
    exit 1
fi

if command -v uv &>/dev/null; then
    uv run "$LAUNCH_SCRIPT" "$TASK" --target-branch "$TARGET_BRANCH" --model claude-4-sonnet-thinking
else
    python3 "$LAUNCH_SCRIPT" "$TASK" --target-branch "$TARGET_BRANCH" --model claude-4-sonnet-thinking
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
read -p "Press Enter to close..."
