#!/bin/bash

echo "=== Emergency Recovery Script ==="
echo "$(date): Starting emergency recovery"

# Kill all lock-related processes
echo "Killing all lock processes..."
sudo pkill -9 hyprlock 2>/dev/null
sudo pkill -9 swaylock 2>/dev/null

# Kill Hyprland completely
echo "Killing Hyprland..."
sudo pkill -9 hyprland 2>/dev/null
sudo pkill -9 Hyprland 2>/dev/null

# Kill waybar and other GUI processes
echo "Killing GUI processes..."
sudo pkill -9 waybar 2>/dev/null
sudo pkill -9 eww 2>/dev/null

# Kill wayland session
echo "Killing wayland session..."
sudo pkill -9 systemctl 2>/dev/null

# Clear any hung processes
echo "Clearing hung processes..."
sudo pkill -9 -f "wayland-wm@hyprland" 2>/dev/null

# Reset graphics
echo "Resetting graphics..."
sudo modprobe -r amdgpu 2>/dev/null
sleep 2
sudo modprobe amdgpu 2>/dev/null

# Wait a moment
sleep 3

# Restart display manager or session
echo "Attempting to restart graphics session..."

# Try to restart the user session
sudo systemctl --user restart graphical-session.target 2>/dev/null || \
sudo systemctl restart display-manager 2>/dev/null || \
{
    echo "Manual restart needed. Run:"
    echo "sudo systemctl restart gdm"
    echo "or"
    echo "sudo systemctl restart sddm"
    echo "or"
    echo "sudo systemctl restart lightdm"
}

echo "=== Recovery attempt completed ==="
echo "If still stuck, try rebooting with: sudo reboot"