# Starship prompt configuration
# https://starship.rs/config/

add_newline = true
command_timeout = 200

format = "${custom.ssh_context}$directory${custom.git_info}$character"

[custom.ssh_context]
command = 'printf "%s@%s" "$USER" "$(hostname)"'
when = '[[ -n "$SSH_CONNECTION" ]]'
format = "[$output](bold cyan) "
shell = ["bash", "--noprofile", "--norc"]

## ------------------------------------------------------------------------------------------------
## ---- Character (prompt symbol)

[character]
error_symbol = "[✗](bold cyan)"
success_symbol = "[❯](bold cyan)"

## ------------------------------------------------------------------------------------------------
## ---- Directory

[directory]
truncation_length = 2
truncation_symbol = "…/"
repo_root_style = "bold cyan"
repo_root_format = "[$repo_root]($repo_root_style)[$path]($style)[$read_only]($read_only_style) "

## ------------------------------------------------------------------------------------------------
## ---- Git module

[custom.git_info]
command = '''
# Run slow operations in parallel using temp files
tmp=$(mktemp -d)
trap "rm -rf $tmp" EXIT

# These 4 operations run in parallel
git status --porcelain 2>/dev/null > "$tmp/status" &
git rev-list --count @{u}..HEAD 2>/dev/null > "$tmp/ahead" &
git rev-list --count HEAD..@{u} 2>/dev/null > "$tmp/behind" &
git diff --shortstat 2>/dev/null > "$tmp/diff" &

# Get branch while parallel ops run (fast)
branch=$(git symbolic-ref --short HEAD 2>/dev/null || git rev-parse --short HEAD 2>/dev/null)
[ -z "$branch" ] && exit 0

wait

# Build status string from parallel results
status=""
ahead=$(cat "$tmp/ahead")
behind=$(cat "$tmp/behind")
[ "$ahead" -gt 0 ] 2>/dev/null && status="${status}⇡${ahead}"
[ "$behind" -gt 0 ] 2>/dev/null && status="${status}⇣${behind}"
grep -q "^??" "$tmp/status" && status="${status}?"
grep -q "^.M\|^M" "$tmp/status" && status="${status}~"

# Parse diff stats: "N files changed, X insertions(+), Y deletions(-)"
additions=$(sed -n 's/.*\([0-9]\+\) insertion.*/\1/p' "$tmp/diff")
deletions=$(sed -n 's/.*\([0-9]\+\) deletion.*/\1/p' "$tmp/diff")

# Output with ANSI colors (magenta=35)
printf "\033[35m%s\033[0m" "$branch"
[ -n "$status" ] && printf " %s" "$status"
[ -n "$additions" ] && printf " \033[90m[\033[32m+%s\033[90m \033[31m-%s\033[90m]\033[0m" "$additions" "${deletions:-0}"
echo ""
'''
format = "$output "
detect_folders = [".git"]
when = ""
shell = ["bash", "--noprofile", "--norc"]
ignore_timeout = true
