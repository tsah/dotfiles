#!/bin/bash
# Focus or launch persistent terminal anywhere; no auto-move

echo "$(date): Script called" >> /tmp/hypr-terminal.log

# Find existing ghostty terminal window (use first one as persistent)
client_info=$(hyprctl clients | awk '
  /^Window/ { 
    addr = $2
  }
  /^\tclass:/ {
    class = $2
  }
  /^\tworkspace:/ {
    workspace = $2
  }
  class == "com.mitchellh.ghostty" && workspace != "" {
    print addr " " workspace
    exit
  }
')

echo "$(date): client_info='$client_info'" >> /tmp/hypr-terminal.log

if [ -n "$client_info" ]; then
  addr=$(echo "$client_info" | awk '{print $1}')
  ws=$(echo "$client_info" | awk '{print $2}')
  echo "$(date): Found window, focusing addr=$addr ws=$ws" >> /tmp/hypr-terminal.log
  # Only switch workspace if we're not already on it
  current_ws=$(hyprctl activeworkspace | head -1 | awk '{print $3}' | tr -d '()')
  if [ "$current_ws" != "$ws" ]; then
    hyprctl dispatch workspace "$ws"
  fi
  hyprctl dispatch focuswindow "address:0x$addr"
  exit 0
fi

echo "$(date): No window found, launching new" >> /tmp/hypr-terminal.log
# None found: launch on workspace 1
hyprctl dispatch workspace 1
hyprctl dispatch exec "uwsm app -- ghostty"